# Define the list of KB numbers with their corresponding OS versions, build numbers, and download links
$KBList = @{
    #"KB5041850" = @{ "Version" = "6.0.6003"; "Link" = "https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/secu/2024/08/windows6.0-kb5041850-x64_625d4d302f4aee5bb67450f7b1de1542f876acbe.msu" };
    #"KB5041847" = @{ "Version" = "6.0.6003"; "Link" = "https://catalog.s.download.windowsupdate.com/d/msdownload/update/software/secu/2024/08/windows6.0-kb5041847-x64_cd154e4445b5a6ea0172b2005f6308f0d2ab86fd.msu" };
    #"KB5041838" = @{ "Version" = "6.1.7601"; "Link" = "https://catalog.s.download.windowsupdate.com/d/msdownload/update/software/secu/2024/08/windows6.1-kb5041838-x64_fd31130f0848305c0d0deac35c7a01b46e758bc6.msu" };
    #"KB5041823" = @{ "Version" = "6.1.7601"; "Link" = "https://catalog.s.download.windowsupdate.com/d/msdownload/update/software/secu/2024/08/windows6.1-kb5041823-x64_775ae31d692ff483471208614b265908d90fdafb.msu" };
    #"KB5041851" = @{ "Version" = "6.2.9200"; "Link" = "https://catalog.s.download.windowsupdate.com/d/msdownload/update/software/secu/2024/08/windows8-rt-kb5041851-x64_2bbdc923d8a43f3ae1cbcde76573760d9fa9137e.msu" };
    "KB5041828" = @{ "Version" = "6.3.9600"; "Link" = "https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/secu/2024/08/windows8.1-kb5041828-x64_78a874c2f777d89bf6f3c8ea82ed00c1300bbf61.msu" };
    #"KB5041782" = @{ "Version" = "10.0.10240"; "Link" = "https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/secu/2024/08/windows10.0-kb5041782-x64_2ad49f5f37b31897254a96e1857473a7f7bc0233.msu" };
    "KB5041773" = @{ "Version" = "10.0.14393"; "Link" = "https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/secu/2024/08/windows10.0-kb5041773-x64_9d8edb92e5824ddc53e1621da1e59c6f8f6e8455.msu" };
    "KB5041578" = @{ "Version" = "10.0.17763"; "Link" = "https://catalog.s.download.windowsupdate.com/d/msdownload/update/software/secu/2024/08/windows10.0-kb5041578-x64_805a87fa976cf1a634ca916575b7896df7a646e3.msu" };
    "KB5041580" = @{ "Version" = "10.0.19045"; "Link" = "https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/secu/2024/08/windows10.0-kb5041580-x64_5afa7baff77b461d9189fc7ea8b4c7a09b31c9ca.cab" };
    "KB5041160" = @{ "Version" = "10.0.20348"; "Link" = "https://catalog.s.download.windowsupdate.com/d/msdownload/update/software/secu/2024/08/windows10.0-kb5041160-x64_f8dc7d5afa74f5b403c918ea78dd82a60626bcfd.msu" };
    "KB5041592" = @{ "Version" = "10.0.22000"; "Link" = "https://catalog.s.download.windowsupdate.com/d/msdownload/update/software/secu/2024/08/windows10.0-kb5041592-x64_7f34aa352ec0ecd3f1a4a323835ee0153052c645.msu" };
    "KB5041585" = @{ "Version" = "10.0.22631"; "Link" = "https://catalog.sf.dl.delivery.mp.microsoft.com/filestreamingservice/files/38b0e2e0-267e-4a3f-b940-3ddf2fe60f5e/public/windows11.0-kb5041585-x64_319b34bb6f8f9053c7cc09e635e541931fbbb111.msu" };
    #"KB5041573" = @{ "Version" = "10.0.25398"; "Link" = "https://catalog.sf.dl.delivery.mp.microsoft.com/filestreamingservice/files/08cf7d44-3284-41e8-82fd-b0c528079221/public/windows11.0-kb5041573-x64_b68aab1e63a2c92452e54043bab6dcac12b11c60.msu" };
    #"KB5041571" = @{ "Version" = "10.0.26100"; "Link" = "https://catalog.sf.dl.delivery.mp.microsoft.com/filestreamingservice/files/be8c1ad5-56ac-422b-9351-86b586bcc2de/public/windows11.0-kb5041571-x64_adcfbf9f2bf5f01a98b91dbd8ebbe65402f896c8.msu" };
}

# Get the OS build number and installed hotfixes
$osInfo = Get-ComputerInfo
$buildNumber = $osInfo.OSVersion
$installedHotFixes = (Get-HotFix).HotFixID

# Find the appropriate KB for the current OS build number
$kbToInstall = $KBList.GetEnumerator() | Where-Object { $_.Value.Version -eq $buildNumber } | Select-Object -ExpandProperty Key
if ($kbToInstall) {
    if ($installedHotFixes -contains $kbToInstall) {
        Write-Output "The KB $kbToInstall is already installed."
    } else {
        Write-Output "The appropriate KB for this OS build number ($buildNumber) is $kbToInstall."
# Get the download link for the KB
        $downloadLink = $KBList[$kbToInstall].Link
# Download the patch
        $patchPath = "C:\temp\$kbToInstall.msu"
        Invoke-WebRequest -Uri $downloadLink -OutFile $patchPath
# Install the patch
        Start-Process -FilePath "wusa.exe" -ArgumentList "$patchPath /quiet /norestart" -Wait
# Clean up the downloaded file
        Remove-Item -Path $patchPath
Write-Output "Installation of $kbToInstall is complete. A restart may be required."
    }
} else {
    Write-Output "No appropriate KB found for this OS build number ($buildNumber)."
}
